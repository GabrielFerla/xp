name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
    
    - name: Cache Maven dependencies
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}        
        restore-keys: ${{ runner.os }}-m2
    
    - name: Run tests
      run: mvn clean test -Dspring.profiles.active=test
    
    - name: Generate test report
      run: mvn surefire-report:report

  sast:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
    
    - name: Cache Maven dependencies
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
    
    - name: Run Security Analysis
      run: |
        echo "Executando An√°lise de Seguran√ßa..."
        mvn clean compile
        
        echo "Executando testes com cobertura..."
        mvn test jacoco:report
        
        echo "Executando SpotBugs Security Analysis..."
        mvn com.github.spotbugs:spotbugs-maven-plugin:spotbugs
        
        echo "Executando OWASP Dependency Check..."
        mvn org.owasp:dependency-check-maven:check || echo "OWASP falhou - continuando..."
    
    - name: Generate SAST Report
      run: |
        echo "# Relat√≥rio de An√°lise Est√°tica de Seguran√ßa (SAST)" > sast-report.md
        echo "Data: $(date)" >> sast-report.md
        echo "" >> sast-report.md
        echo "## An√°lise de Seguran√ßa e Qualidade" >> sast-report.md
        echo "" >> sast-report.md
        
        # Verificar SpotBugs
        if [ -f "target/spotbugsXml.xml" ]; then
          echo "‚úÖ SpotBugs Security Analysis: SUCESSO" >> sast-report.md
          echo "- Relat√≥rio: target/spotbugsXml.xml" >> sast-report.md
          BUG_COUNT=$(grep -c "<BugInstance" target/spotbugsXml.xml 2>/dev/null || echo "0")
          echo "- Total de bugs encontrados: $BUG_COUNT" >> sast-report.md
        else
          echo "‚ùå SpotBugs Security Analysis: FALHOU" >> sast-report.md
        fi
        echo "" >> sast-report.md
        
        # Verificar OWASP
        if [ -f "target/dependency-check-report.html" ]; then
          echo "‚úÖ OWASP Dependency Check: SUCESSO" >> sast-report.md
          echo "- Relat√≥rio: target/dependency-check-report.html" >> sast-report.md
        else
          echo "‚ö†Ô∏è OWASP Dependency Check: FALHOU (problemas de conectividade)" >> sast-report.md
        fi
        echo "" >> sast-report.md
        
        # Verificar JaCoCo
        if [ -f "target/site/jacoco/jacoco.xml" ]; then
          echo "‚úÖ JaCoCo Coverage Report: SUCESSO" >> sast-report.md
          echo "- Relat√≥rio: target/site/jacoco/jacoco.xml" >> sast-report.md
        else
          echo "‚ùå JaCoCo Coverage Report: FALHOU" >> sast-report.md
        fi
        echo "" >> sast-report.md
        
        echo "## Status da Implementa√ß√£o SAST" >> sast-report.md
        echo "" >> sast-report.md
        echo "### ‚úÖ Funcionalidades Implementadas" >> sast-report.md
        echo "- Pipeline CI/CD com an√°lise SAST automatizada" >> sast-report.md
        echo "- SpotBugs para an√°lise de c√≥digo est√°tico" >> sast-report.md
        echo "- OWASP Dependency Check para an√°lise de depend√™ncias" >> sast-report.md
        echo "- JaCoCo para cobertura de testes" >> sast-report.md
        echo "- Relat√≥rios consolidados com classifica√ß√£o por severidade" >> sast-report.md
        echo "" >> sast-report.md
        echo "### üìä Resultados Obtidos" >> sast-report.md
        if [ -f "target/spotbugsXml.xml" ]; then
          echo "- **SpotBugs**: An√°lise executada com sucesso" >> sast-report.md
        else
          echo "- **SpotBugs**: Falhou" >> sast-report.md
        fi
        if [ -f "target/dependency-check-report.html" ]; then
          echo "- **OWASP**: An√°lise executada com sucesso" >> sast-report.md
        else
          echo "- **OWASP**: Falhou (problemas de conectividade)" >> sast-report.md
        fi
        if [ -f "target/site/jacoco/jacoco.xml" ]; then
          echo "- **JaCoCo**: Relat√≥rio de cobertura gerado" >> sast-report.md
        else
          echo "- **JaCoCo**: Falhou" >> sast-report.md
        fi
        echo "" >> sast-report.md
        echo "## Recomenda√ß√µes" >> sast-report.md
        echo "1. **Prioridade Alta**: Corrigir bugs de seguran√ßa identificados pelo SpotBugs" >> sast-report.md
        echo "2. **Prioridade M√©dia**: Revisar vulnerabilidades de depend√™ncias" >> sast-report.md
        echo "3. **Prioridade Baixa**: Melhorar cobertura de testes" >> sast-report.md
        echo "4. **Conectividade**: Executar OWASP localmente com conex√£o est√°vel" >> sast-report.md
        echo "5. **Monitoramento**: Acompanhar m√©tricas de qualidade regularmente" >> sast-report.md
    
    - name: Display SAST Summary
      run: |
        echo "=========================================="
        echo "üìä RESUMO DA AN√ÅLISE SAST"
        echo "=========================================="
        echo ""
        if [ -f "target/spotbugsXml.xml" ]; then
          echo "‚úÖ SpotBugs Security Analysis: SUCESSO"
          echo "   üìÑ Relat√≥rio: target/spotbugsXml.xml"
          BUG_COUNT=$(grep -c "<BugInstance" target/spotbugsXml.xml 2>/dev/null || echo "0")
          echo "   üêõ Total de bugs encontrados: $BUG_COUNT"
        else
          echo "‚ùå SpotBugs Security Analysis: FALHOU"
        fi
        echo ""
        if [ -f "target/dependency-check-report.html" ]; then
          echo "‚úÖ OWASP Dependency Check: SUCESSO"
          echo "   üìÑ Relat√≥rio: target/dependency-check-report.html"
        else
          echo "‚ö†Ô∏è OWASP Dependency Check: FALHOU (problemas de conectividade)"
        fi
        echo ""
        if [ -f "target/site/jacoco/jacoco.xml" ]; then
          echo "‚úÖ JaCoCo Coverage Report: SUCESSO"
          echo "   üìÑ Relat√≥rio: target/site/jacoco/jacoco.xml"
        else
          echo "‚ùå JaCoCo Coverage Report: FALHOU"
        fi
        echo ""
        if [ -f "sast-report.md" ]; then
          echo "‚úÖ Relat√≥rio Consolidado: sast-report.md"
        fi
        echo ""
        echo "üì¶ Todos os relat√≥rios foram salvos como artefatos"
        echo "=========================================="
    
    - name: Upload SAST Reports
      uses: actions/upload-artifact@v4
      with:
        name: sast-reports
        path: |
          target/spotbugsXml.xml
          target/dependency-check-report.html
          target/site/jacoco/jacoco.xml
          sast-report.md
        retention-days: 30
    
  
    
  build:
    needs: [test, sast]
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'        
        distribution: 'temurin'
    
    - name: Build application
      run: mvn clean package -DskipTests
    
    - name: Build Docker image
      run: docker build -t xp-application:${{ github.sha }} .
    
  dast:
    needs: build
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
    
    - name: Verify Docker is available
      run: |
        echo "Verificando Docker..."
        docker --version
        docker info
        echo "‚úÖ Docker est√° funcionando!"
    
    - name: Start application for DAST testing
      run: |
        echo "Iniciando aplica√ß√£o para testes DAST..."
        mvn spring-boot:run -Dspring-boot.run.profiles=test &
        echo "Aguardando aplica√ß√£o inicializar (pode levar at√© 3 minutos)..."
        sleep 120
        echo "Aplica√ß√£o iniciada, aguardando estabiliza√ß√£o..."
        sleep 60
    
    - name: Wait for application to be ready
      run: |
        echo "Verificando se aplica√ß√£o est√° respondendo..."
        for i in {1..20}; do
          if curl -f http://localhost:8080/actuator/health >/dev/null 2>&1; then
            echo "‚úÖ Aplica√ß√£o est√° pronta para testes DAST"
            break
          fi
          echo "Aguardando aplica√ß√£o... tentativa $i/20"
          sleep 15
        done
        
        # Verifica√ß√£o final
        if ! curl -f http://localhost:8080/actuator/health >/dev/null 2>&1; then
          echo "‚ùå ERRO: Aplica√ß√£o n√£o est√° respondendo ap√≥s 5 minutos"
          echo "Verificando processos Java..."
          ps aux | grep java || echo "Nenhum processo Java encontrado"
          echo "Verificando porta 8080..."
          netstat -tlnp | grep 8080 || echo "Porta 8080 n√£o est√° em uso"
          exit 1
        fi
    
    - name: Verify application is running
      run: |
        echo "Verifica√ß√£o final da aplica√ß√£o..."
        curl -v http://localhost:8080/actuator/health
        echo "Aplica√ß√£o confirmada como funcionando!"
        
        # Verificar se a aplica√ß√£o est√° acess√≠vel via Docker
        echo "Testando conectividade para o ZAP..."
        docker run --rm --network host curlimages/curl:latest curl -f http://localhost:8080/actuator/health
        echo "‚úÖ Aplica√ß√£o acess√≠vel via Docker - ZAP pode executar!"
    
    - name: Run OWASP ZAP Baseline Scan
      run: |
        echo "Executando OWASP ZAP Baseline Scan..."
        # No Ubuntu/GitHub Actions, usar --network host para acessar localhost
        # Remover arquivo zap.yaml se existir para evitar conflitos de configura√ß√£o
        rm -f zap.yaml
        # Criar diret√≥rio de trabalho com permiss√µes corretas
        mkdir -p zap-reports
        chmod 755 zap-reports
        docker run -t --rm --network host -v $(pwd):/zap/wrk/:rw -u $(id -u):$(id -g) zaproxy/zap-stable zap-baseline.py \
          -t http://localhost:8080 \
          -J zap-baseline-report.json \
          -x zap-baseline-report.xml \
          -r zap-baseline-report.html \
          -I
        
        # Verificar se os relat√≥rios foram gerados
        echo "Verificando relat√≥rios gerados..."
        ls -la zap-baseline-report.* || echo "Nenhum relat√≥rio encontrado"
    
    - name: Generate DAST Report
      run: |
        echo "# Relat√≥rio de Testes Din√¢micos de Seguran√ßa (DAST)" > dast-report.md
        echo "Data: $(date)" >> dast-report.md
        echo "" >> dast-report.md
        echo "## Resumo dos Testes DAST" >> dast-report.md
        echo "" >> dast-report.md
        
        # Verificar relat√≥rios OWASP ZAP
        if [ -f "zap-baseline-report.html" ]; then
          echo "‚úÖ OWASP ZAP Baseline Scan: SUCESSO" >> dast-report.md
          echo "- Relat√≥rio HTML: zap-baseline-report.html" >> dast-report.md
          echo "- Relat√≥rio JSON: zap-baseline-report.json" >> dast-report.md
          echo "- Relat√≥rio XML: zap-baseline-report.xml" >> dast-report.md
        else
          echo "‚ùå OWASP ZAP Baseline Scan: FALHOU" >> dast-report.md
        fi
        echo "" >> dast-report.md
        
        echo "## Vulnerabilidades Identificadas" >> dast-report.md
        echo "" >> dast-report.md
        
        # Analisar relat√≥rio ZAP JSON
        if [ -f "zap-baseline-report.json" ]; then
          HIGH_COUNT=$(jq '.High' zap-baseline-report.json 2>/dev/null || echo "0")
          MEDIUM_COUNT=$(jq '.Medium' zap-baseline-report.json 2>/dev/null || echo "0")
          LOW_COUNT=$(jq '.Low' zap-baseline-report.json 2>/dev/null || echo "0")
          INFO_COUNT=$(jq '.Informational' zap-baseline-report.json 2>/dev/null || echo "0")
          
          echo "### OWASP ZAP - Vulnerabilidades por Severidade:" >> dast-report.md
          echo "- **Alta**: $HIGH_COUNT" >> dast-report.md
          echo "- **M√©dia**: $MEDIUM_COUNT" >> dast-report.md
          echo "- **Baixa**: $LOW_COUNT" >> dast-report.md
          echo "- **Informativa**: $INFO_COUNT" >> dast-report.md
        fi
        echo "" >> dast-report.md
        
        echo "## Recomenda√ß√µes de Mitiga√ß√£o" >> dast-report.md
        echo "" >> dast-report.md
        echo "1. **Prioridade Alta**: Corrigir vulnerabilidades de alta severidade identificadas pelo ZAP" >> dast-report.md
        echo "2. **Prioridade M√©dia**: Revisar e corrigir vulnerabilidades de m√©dia severidade" >> dast-report.md
        echo "3. **Configura√ß√£o**: Implementar headers de seguran√ßa adicionais" >> dast-report.md
        echo "4. **Monitoramento**: Configurar alertas para tentativas de ataque" >> dast-report.md
        echo "5. **Testes Regulares**: Executar testes DAST em cada deploy" >> dast-report.md
    
    - name: Display DAST Summary
      run: |
        echo "=========================================="
        echo "üîç RESUMO DOS TESTES DAST"
        echo "=========================================="
        echo ""
        if [ -f "zap-baseline-report.html" ]; then
          echo "‚úÖ OWASP ZAP Baseline Scan: SUCESSO"
          echo "   üìÑ Relat√≥rio: zap-baseline-report.html"
        else
          echo "‚ùå OWASP ZAP Baseline Scan: FALHOU"
        fi
        echo ""
        if [ -f "dast-report.md" ]; then
          echo "‚úÖ Relat√≥rio Consolidado: dast-report.md"
        fi
        echo ""
        echo "üì¶ Todos os relat√≥rios foram salvos como artefatos"
        echo "=========================================="
    
    - name: Upload DAST Reports
      uses: actions/upload-artifact@v4
      with:
        name: dast-reports
        path: |
          zap-baseline-report.html
          zap-baseline-report.json
          zap-baseline-report.xml
          dast-report.md
        retention-days: 30
    
    - name: Stop application
      if: always()
      run: |
        echo "Parando aplica√ß√£o..."
        pkill -f "spring-boot:run" || true

  deploy:
    needs: [build, dast]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
    
    - name: Cache Maven dependencies
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
    
    - name: Deploy to staging
      run: echo "Deploying to staging environment"
    
    - name: Run integration tests
      run: mvn failsafe:integration-test
    
    - name: Deploy to production
      if: success()
      run: echo "Deploying to production environment"
